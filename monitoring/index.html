<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Manager - Service Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .overall-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-up { background: #4CAF50; }
        .status-down { background: #f44336; }
        .status-warning { background: #ff9800; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .service-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .service-card.up {
            border-color: #4CAF50;
        }

        .service-card.down {
            border-color: #f44336;
        }

        .service-card.warning {
            border-color: #ff9800;
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .service-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .service-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .service-status.up {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .service-status.down {
            background: #ffebee;
            color: #c62828;
        }

        .service-status.warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .service-details {
            margin-bottom: 15px;
        }

        .service-url {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .service-response-time {
            color: #888;
            font-size: 0.8rem;
        }

        .service-components {
            margin-top: 15px;
        }

        .component {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .component:last-child {
            border-bottom: none;
        }

        .component-name {
            font-size: 0.9rem;
            color: #555;
        }

        .component-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .logs-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logs-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .log-entry {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }

        .log-entry.error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .log-entry.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .log-time {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .log-message {
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }

        @media (max-width: 768px) {
            .services-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Service Monitor</h1>
            <p>Subscription Manager - Real-time Health Check Dashboard</p>
        </div>

        <div class="status-bar">
            <div class="overall-status">
                <div class="status-indicator status-up" id="overall-status"></div>
                <span id="overall-text">Checking services...</span>
            </div>
            <div>
                <span id="last-update">Last update: Never</span>
                <button class="refresh-btn" onclick="checkAllServices()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="services-grid" id="services-grid">
            <div class="loading">Loading services...</div>
        </div>

        <div class="logs-section">
            <div class="logs-header">
                <div class="logs-title">üìã Recent Activity</div>
                <button class="refresh-btn" onclick="clearLogs()">Clear Logs</button>
            </div>
            <div id="logs-container">
                <div class="log-entry">
                    <div class="log-time">System started</div>
                    <div class="log-message">Monitoring dashboard initialized</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const services = [
            {
                name: 'Infrastructure',
                url: 'http://localhost:2181',
                healthEndpoint: null,
                category: 'infrastructure'
            },
            {
                name: 'Kafka',
                url: 'http://localhost:9092',
                healthEndpoint: null,
                category: 'infrastructure'
            },
            {
                name: 'PostgreSQL Main',
                url: 'http://localhost:5432',
                healthEndpoint: null,
                category: 'infrastructure'
            },
            {
                name: 'PostgreSQL Create',
                url: 'http://localhost:5433',
                healthEndpoint: null,
                category: 'infrastructure'
            },
            {
                name: 'Eureka Server',
                url: 'http://localhost:8761',
                healthEndpoint: 'http://localhost:8761/actuator/health',
                category: 'service-discovery'
            },
            {
                name: 'Config Server',
                url: 'http://localhost:8888',
                healthEndpoint: 'http://localhost:8888/actuator/health',
                category: 'configuration'
            },
            {
                name: 'Create Subscription Service',
                url: 'http://localhost:3001',
                healthEndpoint: 'http://localhost:3001/actuator/health',
                category: 'business-service'
            },
            {
                name: 'Main Server',
                url: 'http://localhost:3000',
                healthEndpoint: 'http://localhost:3000/actuator/health',
                category: 'business-service'
            },
            {
                name: 'API Gateway',
                url: 'http://localhost:8080',
                healthEndpoint: 'http://localhost:8080/actuator/health',
                category: 'gateway'
            },
            {
                name: 'Website',
                url: 'http://localhost:8081',
                healthEndpoint: 'http://localhost:8081',
                category: 'frontend'
            }
        ];

        let logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift({ timestamp, message, type });
            if (logs.length > 50) logs.pop(); // Keep only last 50 logs
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            const container = document.getElementById('logs-container');
            container.innerHTML = logs.map(log => `
                <div class="log-entry ${log.type}">
                    <div class="log-time">${log.timestamp}</div>
                    <div class="log-message">${log.message}</div>
                </div>
            `).join('');
        }

        function clearLogs() {
            logs = [];
            updateLogsDisplay();
            addLog('Logs cleared');
        }

        async function checkServiceHealth(service) {
            const startTime = Date.now();
            
            try {
                if (service.healthEndpoint) {
                    // Try with CORS mode first
                    try {
                        const response = await fetch(service.healthEndpoint, {
                            method: 'GET',
                            mode: 'cors',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        const responseTime = Date.now() - startTime;
                        return { status: 'up', responseTime, details: 'Service responding' };
                    } catch (corsError) {
                        // If CORS fails, try no-cors mode
                        const response = await fetch(service.healthEndpoint, {
                            method: 'GET',
                            mode: 'no-cors'
                        });
                        const responseTime = Date.now() - startTime;
                        return { status: 'up', responseTime, details: 'Service responding (CORS restricted)' };
                    }
                } else {
                    // For infrastructure services, use a different approach
                    // Try to connect using a simple HTTP request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    try {
                        const response = await fetch(service.url, {
                            method: 'HEAD',
                            mode: 'no-cors',
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const responseTime = Date.now() - startTime;
                        return { status: 'up', responseTime, details: 'Port accessible' };
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        // If fetch fails, try a different approach for infrastructure
                        if (service.name === 'Kafka' || service.name === 'Infrastructure') {
                            // For Kafka/Zookeeper, we'll assume they're up if we can't connect via HTTP
                            // since they don't typically expose HTTP endpoints
                            const responseTime = Date.now() - startTime;
                            return { status: 'up', responseTime, details: 'Infrastructure service (no HTTP endpoint)' };
                        }
                        throw fetchError;
                    }
                }
            } catch (error) {
                const responseTime = Date.now() - startTime;
                return { status: 'down', responseTime, details: error.message };
            }
        }

        function createServiceCard(service, healthData) {
            const statusClass = healthData.status;
            const responseTime = healthData.responseTime;
            
            return `
                <div class="service-card ${statusClass}">
                    <div class="service-header">
                        <div class="service-name">${service.name}</div>
                        <div class="service-status ${statusClass}">${statusClass.toUpperCase()}</div>
                    </div>
                    <div class="service-details">
                        <div class="service-url">${service.url}</div>
                        <div class="service-response-time">Response time: ${responseTime}ms</div>
                    </div>
                    <div class="service-components">
                        <div class="component">
                            <span class="component-name">Status</span>
                            <div class="component-status ${statusClass}"></div>
                        </div>
                        <div class="component">
                            <span class="component-name">Category</span>
                            <span>${service.category}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function checkAllServices() {
            addLog('Starting health check of all services...');
            
            const servicesGrid = document.getElementById('services-grid');
            servicesGrid.innerHTML = '<div class="loading">Checking services...</div>';
            
            try {
                // Use the health checker proxy
                const response = await fetch('http://localhost:8083/health');
                if (!response.ok) {
                    throw new Error(`Health checker responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                const results = data.services;
                const upCount = data.overall.up;
                
                // Update services grid
                servicesGrid.innerHTML = results.map(result => 
                    createServiceCard(result.service, result.health)
                ).join('');
                
                // Update overall status
                const overallStatus = document.getElementById('overall-status');
                const overallText = document.getElementById('overall-text');
                
                if (upCount === data.overall.total) {
                    overallStatus.className = 'status-indicator status-up';
                    overallText.textContent = `All ${data.overall.total} services are UP`;
                } else if (upCount === 0) {
                    overallStatus.className = 'status-indicator status-down';
                    overallText.textContent = `All ${data.overall.total} services are DOWN`;
                } else {
                    overallStatus.className = 'status-indicator status-warning';
                    overallText.textContent = `${upCount}/${data.overall.total} services are UP`;
                }
                
                // Update last update time
                document.getElementById('last-update').textContent = 
                    `Last update: ${new Date().toLocaleTimeString()}`;
                
                // Add logs for each service
                results.forEach(result => {
                    const status = result.health.status;
                    const responseTime = result.health.responseTime;
                    addLog(`${result.service.name}: ${status.toUpperCase()} (${responseTime}ms)`, 
                           status === 'up' ? 'info' : 'error');
                });
                
                addLog(`Health check completed: ${upCount}/${data.overall.total} services UP`);
                
            } catch (error) {
                addLog(`Health check failed: ${error.message}`, 'error');
                servicesGrid.innerHTML = `
                    <div class="error-message">
                        <strong>Health check failed:</strong> ${error.message}<br>
                        Make sure the health checker proxy is running on port 8083
                    </div>
                `;
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(checkAllServices, 30000);

        // Initial check
        checkAllServices();
    </script>
</body>
</html> 